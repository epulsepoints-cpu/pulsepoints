<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Notification Action URLs</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .title {
            color: #2563eb;
            margin-bottom: 20px;
            text-align: center;
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 500;
        }
        .status.info { background: #dbeafe; color: #1e40af; }
        .status.success { background: #dcfce7; color: #166534; }
        .status.error { background: #fee2e2; color: #dc2626; }
        .status.warning { background: #fef3c7; color: #d97706; }
        
        .btn {
            background: #2563eb;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 5px;
        }
        .btn:hover { background: #1d4ed8; }
        .btn:disabled { 
            background: #9ca3af; 
            cursor: not-allowed; 
        }
        
        .progress {
            width: 100%;
            height: 20px;
            background: #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }
        .progress-bar {
            height: 100%;
            background: #10b981;
            transition: width 0.3s ease;
        }
        
        .log {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat {
            text-align: center;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 4px solid #2563eb;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #2563eb;
        }
        .stat-label {
            color: #64748b;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">üîß Notification Action URL Fixer</h1>
        
        <div class="status info">
            <strong>üìã What this tool does:</strong><br>
            ‚Ä¢ Scans all notifications in your Firebase database<br>
            ‚Ä¢ Adds proper action URLs to notifications that are missing them<br>
            ‚Ä¢ Ensures clicking notifications navigates to the right place<br>
            ‚Ä¢ Works with your current authentication context
        </div>

        <div style="text-align: center; margin: 20px 0;">
            <button id="loginBtn" class="btn">üîê Login to Firebase</button>
            <button id="fixBtn" class="btn" disabled>üîß Fix Notifications</button>
            <button id="testBtn" class="btn" disabled>üß™ Test Single Notification</button>
        </div>

        <div class="progress" style="display: none;" id="progressContainer">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <div class="stats" id="stats" style="display: none;">
            <div class="stat">
                <div class="stat-number" id="totalCount">0</div>
                <div class="stat-label">Total Notifications</div>
            </div>
            <div class="stat">
                <div class="stat-number" id="fixedCount">0</div>
                <div class="stat-label">Fixed</div>
            </div>
            <div class="stat">
                <div class="stat-number" id="skippedCount">0</div>
                <div class="stat-label">Already OK</div>
            </div>
            <div class="stat">
                <div class="stat-number" id="errorCount">0</div>
                <div class="stat-label">Errors</div>
            </div>
        </div>

        <div class="log" id="log" style="display: none;"></div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getAuth, 
            signInWithPopup, 
            signInWithRedirect,
            getRedirectResult,
            GoogleAuthProvider,
            onAuthStateChanged 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            getFirestore, 
            collection, 
            getDocs, 
            updateDoc, 
            doc,
            addDoc 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDA_jAATsA4_W98bkoACjaWDNI3Lupyb4I",
            authDomain: "ecgkid-pulsepoint.firebaseapp.com",
            projectId: "ecgkid-pulsepoint",
            storageBucket: "ecgkid-pulsepoint.firebasestorage.app",
            messagingSenderId: "951967187678",
            appId: "1:951967187678:web:2982df3b09e6a64845f84f",
            measurementId: "G-KZ066Y7VDC"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // DOM elements
        const loginBtn = document.getElementById('loginBtn');
        const fixBtn = document.getElementById('fixBtn');
        const testBtn = document.getElementById('testBtn');
        const log = document.getElementById('log');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const stats = document.getElementById('stats');

        let currentUser = null;

        // Logging function
        function logMessage(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            console.log(logEntry);
            
            if (log.style.display === 'none') {
                log.style.display = 'block';
            }
            
            const colors = {
                info: '#60a5fa',
                success: '#34d399',
                error: '#f87171',
                warning: '#fbbf24'
            };
            
            log.innerHTML += `<div style="color: ${colors[type] || colors.info}">${logEntry}</div>`;
            log.scrollTop = log.scrollBottom;
        }

        // Update stats display
        function updateStats(total, fixed, skipped, errors) {
            document.getElementById('totalCount').textContent = total;
            document.getElementById('fixedCount').textContent = fixed;
            document.getElementById('skippedCount').textContent = skipped;
            document.getElementById('errorCount').textContent = errors;
            
            if (stats.style.display === 'none') {
                stats.style.display = 'grid';
            }
        }

        // Update progress bar
        function updateProgress(current, total) {
            const percentage = total > 0 ? (current / total) * 100 : 0;
            progressBar.style.width = `${percentage}%`;
            
            if (progressContainer.style.display === 'none') {
                progressContainer.style.display = 'block';
            }
        }

        // Generate action URL based on notification type
        function getDefaultActionUrl(type, data = {}) {
            switch (type) {
                case 'lesson':
                case 'lesson_complete':
                    return data.lessonId ? `/learn/${data.lessonId}` : '/learn';
                
                case 'achievement':
                case 'rank_up':
                    return '/profile?tab=achievements';
                
                case 'progress':
                case 'streak':
                case 'daily_goal':
                    return '/dashboard?tab=progress';
                
                case 'module_unlock':
                    return data.moduleId ? `/modules/${data.moduleId}` : '/learn';
                
                case 'reminder':
                    return '/dashboard';
                
                case 'social':
                    return '/leaderboard';
                
                case 'reward':
                    return '/rewards';
                
                case 'system':
                default:
                    return '/dashboard';
            }
        }

        // Authentication
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                loginBtn.textContent = `üë§ ${user.displayName || user.email}`;
                loginBtn.disabled = true;
                fixBtn.disabled = false;
                testBtn.disabled = false;
                logMessage(`‚úÖ Authenticated as ${user.displayName || user.email}`, 'success');
            } else {
                loginBtn.textContent = 'üîê Login to Firebase';
                loginBtn.disabled = false;
                fixBtn.disabled = true;
                testBtn.disabled = true;
                logMessage('‚ùå Not authenticated', 'error');
            }
        });

        // Check for redirect result on page load
        getRedirectResult(auth)
            .then((result) => {
                if (result) {
                    logMessage('üéâ Login successful!', 'success');
                }
            })
            .catch((error) => {
                if (error.code !== 'auth/popup-closed-by-user') {
                    logMessage(`‚ùå Login error: ${error.message}`, 'error');
                }
            });

        loginBtn.addEventListener('click', async () => {
            try {
                logMessage('üîÑ Redirecting to login...', 'info');
                const provider = new GoogleAuthProvider();
                
                // Try popup first, fallback to redirect if blocked
                try {
                    await signInWithPopup(auth, provider);
                    logMessage('üéâ Login successful!', 'success');
                } catch (popupError) {
                    if (popupError.code === 'auth/popup-blocked') {
                        logMessage('‚ö†Ô∏è Popup blocked, using redirect method...', 'warning');
                        await signInWithRedirect(auth, provider);
                    } else {
                        throw popupError;
                    }
                }
            } catch (error) {
                logMessage(`‚ùå Login failed: ${error.message}`, 'error');
            }
        });

        // Test single notification
        testBtn.addEventListener('click', async () => {
            if (!currentUser) {
                logMessage('‚ùå Please login first', 'error');
                return;
            }

            try {
                logMessage('üß™ Creating test notification...', 'info');
                
                const testNotification = {
                    userId: currentUser.uid,
                    type: 'lesson',
                    title: 'Test Notification',
                    body: 'This is a test notification with action URL',
                    actionUrl: getDefaultActionUrl('lesson', { lessonId: 'test-lesson-123' }),
                    timestamp: new Date(),
                    read: false,
                    priority: 'normal',
                    data: { lessonId: 'test-lesson-123' }
                };

                const docRef = await addDoc(collection(db, 'userNotifications'), testNotification);
                logMessage(`‚úÖ Test notification created with ID: ${docRef.id}`, 'success');
                logMessage(`üîó Action URL: ${testNotification.actionUrl}`, 'info');
                
            } catch (error) {
                logMessage(`‚ùå Test failed: ${error.message}`, 'error');
            }
        });

        // Fix notifications
        fixBtn.addEventListener('click', async () => {
            if (!currentUser) {
                logMessage('‚ùå Please login first', 'error');
                return;
            }

            logMessage('üöÄ Starting notification fix process...', 'info');
            fixBtn.disabled = true;
            testBtn.disabled = true;

            let totalCount = 0;
            let fixedCount = 0;
            let skippedCount = 0;
            let errorCount = 0;

            try {
                // Get all notifications
                logMessage('üìä Fetching all notifications...', 'info');
                const notificationsRef = collection(db, 'userNotifications');
                const snapshot = await getDocs(notificationsRef);
                
                totalCount = snapshot.size;
                logMessage(`üìã Found ${totalCount} notifications to check`, 'info');

                let processed = 0;

                for (const notificationDoc of snapshot.docs) {
                    try {
                        const data = notificationDoc.data();
                        processed++;
                        updateProgress(processed, totalCount);

                        // Check if notification needs action URL
                        if (!data.actionUrl || data.actionUrl === '' || data.actionUrl === '/') {
                            // Generate appropriate action URL
                            const defaultActionUrl = getDefaultActionUrl(data.type, data.data || {});
                            
                            // Update the notification
                            await updateDoc(doc(db, 'userNotifications', notificationDoc.id), {
                                actionUrl: defaultActionUrl
                            });
                            
                            fixedCount++;
                            
                            if (fixedCount % 5 === 0) {
                                logMessage(`‚úÖ Fixed ${fixedCount} notifications...`, 'success');
                            }
                            
                        } else {
                            skippedCount++;
                        }

                        updateStats(totalCount, fixedCount, skippedCount, errorCount);

                    } catch (error) {
                        errorCount++;
                        logMessage(`‚ùå Error fixing notification ${notificationDoc.id}: ${error.message}`, 'error');
                        updateStats(totalCount, fixedCount, skippedCount, errorCount);
                    }
                }

                // Final results
                logMessage('', 'info');
                logMessage('üéØ NOTIFICATION FIX COMPLETE!', 'success');
                logMessage(`üìä Total notifications: ${totalCount}`, 'info');
                logMessage(`‚úÖ Fixed: ${fixedCount}`, 'success');
                logMessage(`‚è≠Ô∏è  Already OK: ${skippedCount}`, 'info');
                logMessage(`‚ùå Errors: ${errorCount}`, 'error');
                
                const successRate = totalCount > 0 ? ((fixedCount + skippedCount) / totalCount * 100).toFixed(1) : 0;
                logMessage(`üíØ Success rate: ${successRate}%`, 'success');

            } catch (error) {
                logMessage(`üí• Fix process failed: ${error.message}`, 'error');
                errorCount++;
                updateStats(totalCount, fixedCount, skippedCount, errorCount);
            } finally {
                fixBtn.disabled = false;
                testBtn.disabled = false;
                logMessage('‚ú® Process completed!', 'success');
            }
        });

        // Initial log
        logMessage('üîß Notification Action URL Fixer loaded', 'info');
        logMessage('üëÜ Click "Login to Firebase" to get started', 'info');
    </script>
</body>
</html>
